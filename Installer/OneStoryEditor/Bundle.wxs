<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:bal="http://schemas.microsoft.com/wix/BalExtension"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension"
     xmlns:netfx="http://schemas.microsoft.com/wix/NetFxExtension">
  
	<Bundle		Name='$(var.ApplicationName) $(var.TruncatedVersion)'
			      Version='$(var.VersionNumber)'
			      UpgradeCode='$(var.UpgradeCode)'
			      Tag='$(var.ApplicationName)'
			      IconSourceFile='Installer.ico'
			      Copyright='Copyright Â© $(var.Year), $(var.Manufacturer)'
			      Manufacturer='$(var.Manufacturer)'>

    <bal:Condition Message="XP is no longer supported."> (VersionNT &gt;= v6.0) </bal:Condition>
    <BootstrapperApplicationRef Id="WixStandardBootstrapperApplication.RtfLicense">
      <bal:WixStandardBootstrapperApplication
            LicenseFile="..\License.rtf"
            />
    </BootstrapperApplicationRef>

    <WixVariable Id="WixStdbaLicenseUrl" Value="..\License.rtf" />
    <WixVariable Id="WixStdbaLogo" Value="bundle_background.bmp" />
    <WixVariable Id="WixStdbaThemeXml" Value="BundleTheme.xml" />
    <WixVariable Id="WixStdbaThemeWxl" Value="BundleTheme.wxl" />
    <Chain>
      <PackageGroupRef Id="NetFx48Web" />
      <PackageGroupRef Id="redist_vc15to19" />
      <RollbackBoundary />
      <PackageGroupRef Id='AppPackageGroup'/>
    </Chain>

  </Bundle>

  <?if $(var.Platform) = x64 ?>
  <?define msiFilename = "Setup OneStory Editor_x64.msi" ?>
  <?else ?>
  <?define msiFilename = "Setup OneStory Editor_x86.msi" ?>
  <?endif ?>

  <Fragment Id='AppFragment'>
    <PackageGroup Id='AppPackageGroup'>
      <MsiPackage Id='AppMsiPackage'
					DisplayName='$(var.ApplicationName) $(var.VersionNumber)'
					DisplayInternalUI='yes'
					ForcePerMachine='yes'
					InstallCondition='1'
					SourceFile='$(var.SolutionDir)output\$(var.msiFilename)'
					Visible='yes'
					Vital='yes'>

      </MsiPackage>
    </PackageGroup>

  </Fragment>


  <!--
      .NET Framework installation state properties
      Official documentation can be found at the following location:
      .NET Framework 4.5/4.5.1/4.5.2/4.6/4.6.1/4.6.2/4.7/4.7.1/4.8 - https://msdn.microsoft.com/en-us/library/w0x726c2(v=vs.110).aspx
   -->

  <?define NetFx48MinRelease = 528040 ?>
  <?define NetFx48WebLink = https://go.microsoft.com/fwlink/?LinkId=2085155 ?>
  <?define NetFx48RedistLink = https://go.microsoft.com/fwlink/?linkid=2088631 ?>
  <?define NetFx48EulaLink = https://referencesource.microsoft.com/license.html ?>

  <Fragment>
    <PropertyRef Id="WIXNETFX4RELEASEINSTALLED" />
    <Property Id="WIX_IS_NETFRAMEWORK_48_OR_LATER_INSTALLED" Secure="yes" />
    <SetProperty Id="WIX_IS_NETFRAMEWORK_48_OR_LATER_INSTALLED" Value="1" After="AppSearch">
      WIXNETFX4RELEASEINSTALLED >= "#$(var.NetFx48MinRelease)"
    </SetProperty>
  </Fragment>

  <Fragment>
    <util:RegistrySearchRef Id="NETFRAMEWORK45"/>

    <WixVariable Id="WixMbaPrereqPackageId" Value="NetFx48Web" />
    <WixVariable Id="WixMbaPrereqLicenseUrl" Value="$(var.NetFx48EulaLink)" Overridable="yes" />
    <WixVariable Id="NetFx48WebDetectCondition" Value="NETFRAMEWORK45 &gt;= $(var.NetFx48MinRelease)" Overridable="yes" />
    <WixVariable Id="NetFx48WebInstallCondition" Value="" Overridable="yes" />
    <WixVariable Id="NetFx48WebPackageDirectory" Value="redist\" Overridable="yes" />

    <PackageGroup Id="NetFx48Web">
      <ExePackage
          InstallCommand="/q /norestart /ChainingPackage &quot;[WixBundleName]&quot; /log &quot;[NetFx48FullLog].html&quot;"
          RepairCommand="/q /norestart /repair /ChainingPackage &quot;[WixBundleName]&quot; /log &quot;[NetFx48FullLog].html&quot;"
          UninstallCommand="/uninstall /q /norestart /ChainingPackage &quot;[WixBundleName]&quot; /log &quot;[NetFx48FullLog].html&quot;"
          PerMachine="yes"
          DetectCondition="!(wix.NetFx48WebDetectCondition)"
          InstallCondition="!(wix.NetFx48WebInstallCondition)"
          Id="NetFx48Web"
          Vital="yes"
          Permanent="yes"
          Protocol="netfx4"
          DownloadUrl="$(var.NetFx48WebLink)"
          LogPathVariable="NetFx48FullLog"
          Compressed="no"
          Name="!(wix.NetFx48WebPackageDirectory)ndp48-web.exe">
        <RemotePayload
          CertificatePublicKey="793980B0038EBF0A88DAA08420FD3E66F53CC0CE"
          CertificateThumbprint="9DC17888B5CFAD98B3CB35C1994E96227F061675"
          Description="Microsoft .NET Framework 4.8 Setup"
          Hash="755349ECD6A478FE010E466B29911D2388F6CE94"
          ProductName="Microsoft .NET Framework 4.8"
          Size="1486376"
          Version="4.8.3761.0" />
      </ExePackage>
    </PackageGroup>
  </Fragment>

  <?if $(sys.BUILDARCH)="x86"?>
  <!-- 32bit VC++ redistributable download section -->
  <!-- When updating or adding a redistributable you can generate the RemotePayload with the WIX's heat tool -->
  <!-- e.g. "%WIX%\bin\heat" payload C:\fwroot\fw\PatchableInstaller\libs\vcredist_2008_x64.exe -o c:\Repositories\fw\PatchableInstaller\VC2008Frag.wxs -->
  <?define VC15to19RedistWebLink = https://download.visualstudio.microsoft.com/download/pr/888b4c07-c602-499a-9efb-411188496ce7/F3A86393234099BEDD558FD35AB538A6E4D9D4F99AD5ADFA13F603D4FF8A42DC/VC_redist.x86.exe ?>
  <Fragment>
    <util:RegistrySearch Root="HKLM"
					Key="SOFTWARE\Microsoft\VisualStudio\14.0\VC\Runtimes\X86"
					Variable="CPP2017Redist"
					Value="Installed"
					Result="value"/>
    <PackageGroup Id="redist_vc15to19">
      <ExePackage Id="vc17" Cache="no" PerMachine="yes" Vital="yes" Compressed="no" Permanent="yes"
					Name="vcredist_x86.exe"
					DownloadUrl="$(var.VC15to19RedistWebLink)"
					InstallCommand="/quiet /norestart"
					DetectCondition="CPP2017Redist">
        <RemotePayload
					Size="13782072"
					Version="14.29.30040.0"
					ProductName="Microsoft Visual C++ 2015-2019 Redistributable (x86) - 14.28.29914"
					Description="Microsoft Visual C++ 2015-2019 Redistributable (x86) - 14.28.29914"
					Hash="FBE4B370A346BBA08690EAF7C4EB4AFF20C94181" />
      </ExePackage>
    </PackageGroup>
  </Fragment>
  <?elseif $(sys.BUILDARCH)="x64"?>
  <!-- 64bit  VC++ redistributable download section -->
  <!-- When updating or adding a redistributable you can generate the RemotePayload with the WIX's heat tool -->
  <!-- e.g. "%WIX%\bin\heat" payload C:\fwroot\fw\PatchableInstaller\libs\vcredist_2008_x64.exe -o c:\Repositories\fw\PatchableInstaller\VC2008Frag.wxs -->
  <?define VC15to19RedistWebLink = https://download.visualstudio.microsoft.com/download/pr/36e45907-8554-4390-ba70-9f6306924167/97CC5066EB3C7246CF89B735AE0F5A5304A7EE33DC087D65D9DFF3A1A73FE803/VC_redist.x64.exe ?>
  <Fragment>
    <util:RegistrySearch Root="HKLM"
					Key="SOFTWARE\Microsoft\VisualStudio\14.0\VC\Runtimes\X64"
					Variable="CPP2017Redist64"
					Value="Installed"
					Result="value"
					Win64="yes"/>
    <util:RegistrySearch Root="HKLM"
					Key="SOFTWARE\Microsoft\VisualStudio\14.0\VC\Runtimes\X64"
					Variable="CPP2017Redist32"
					Value="Installed"
					Result="value"
					Win64="no"/>
    <PackageGroup Id="redist_vc15to19">
      <ExePackage Id="vc17" Cache="no" PerMachine="yes" Vital="yes" Compressed="no" Permanent="yes"
					Name="vc_redist.x64.exe"
					DownloadUrl="$(var.VC15to19RedistWebLink)"
					InstallCommand="/quiet /norestart"
					DetectCondition="(CPP2017Redist32) OR (CPP2017Redist64)">
        <RemotePayload
					Size="25169400"
					Version="14.29.30040.0"
					ProductName="Microsoft Visual C++ 2015-2019 Redistributable (x64) - 14.28.29914"
					Description="Microsoft Visual C++ 2015-2019 Redistributable (x64) - 14.28.29914"
					Hash="9ADE54D322BE27BFF05D5AFEC8ED44F9B2D9306E" />
        <ExitCode Value="1638" Behavior="success"/>
        <!-- Don't fail if newer version is installed -->
      </ExePackage>
    </PackageGroup>
  </Fragment>
  <?else?>
  <?error Unsupported value of sys.BUILDARCH=$(sys.BUILDARCH)?>
  <?endif?>

</Wix>
